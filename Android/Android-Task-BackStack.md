# 작업 및 백 스택 이해

## 백스택

작업 = 태스크(task), 활동 = 액티비티(Activity)

작업은 사용자가 특정 작업을 할 때 상호작용하는 액티비티의 컬렉션이다. 액티비티는 스택(백스택)에 각 액티비티가 열린 순서대로 정렬된다. 예를 들어 이메일 앱에는 새 메시지 목록을 표시하는 액티비티가 하나 있을 수 있다. 사용자가 메시지를 선택하면 메시지를 볼 수 있도록 새 액티비티가 열립니다. 새로운 액티비티는 백 스택에 추가된다. 사용자가 뒤로 버튼을 누르면 새로운 액티비티가 완료되고 스택에서 팝 된다.

기기의 홈 화면은 대부분의 작업이 시작되는 위치이다. 사용자가 앱 런처의 아이콘(또는 홈 화면의 바로가기)을 터치하면 앱의 작업이 포그라운드로 나온다. 앱의 작업이 없으면(앱이 최근에 사용된 적이 없으면) 새 작업이 생성되고 이 앱의 '기본' 액티비티가 스택의 루트 액티비티으로 열린다.

현재 액티비티가 또 다른 액티비티을 시작하면 새 액티비티가 스택의 맨 위에 푸시되고 포커스를 갖게 됩니다. 이전 액티비티는 스택에 남아있지만 중지됩니다. 액티비티가 중지되면 시스템은 액티비티의 사용자 인터페이스가 갖고 있는 현재 상태를 보존합니다. 사용자가 뒤로 버튼을 누르면 현재 액티비티가 스택의 맨 위에서 팝되고(액티비티가 제거되고) 이전 액티비티가 다시 시작됩니다(UI의 이전 상태가 복원됨).

백 스택은 'LIFO(후입선출)' 객체 구조로 작동한다. 아래 그림 참조

<br>

<p align="center">

<img src="https://github.com/dudwns9331/2021-Summer-Kotlin/blob/master/Summer-Technical-Note/assets/diagram_backstack.PNG" width="600px" height="190px"/>

</p>

<br>

정리하자면 액티비티는 새로 생성될 때마다 위로 겹쳐서 쌓이는 형식이고 이는 뒤로가기(종료) 를 통해서 하나씩 내보낼 수 있다. 그리고 밑에 쌓이는(현재 보여지지 않는) 액티비티들은 정지 상태를 가지게 된다. 또한, 같은 액티비티가 다른 프로세스에서 호출되어 중복될 수 있다. 이는 작업 관리를 통해서 조절 가능하다. 태스크는 백그라운드로 내려갈 수 있는 액티비티들의 묶음을 뜻한다.

<br>

<p align="center">

<img src="https://github.com/dudwns9331/2021-Summer-Kotlin/blob/master/Summer-Technical-Note/assets/diagram_multiple_instances.PNG" width="400px" height="380px"/>

</p>

<br>

---

## 작업 관리

**1. manifest 파일 사용**

manifest 파일에서 활동을 선언할 때 `<activity>` 요소의 `launchMode` 속성을 사용하여 활동이 작업과 연결되어야 하는 방식을 지정할 수 있다.

- standard (기본모드)

  기본값이다. 시스템은 활동이 시작된 작업에 활동의 새 인스턴스를 생성하고 인텐트를 인스턴스로 라우팅한다. 활동은 여러 번 인스턴스화될 수 있고 각 인스턴스는 서로 다른 작업에 속할 수 있으며 한 작업에는 여러 인스턴스가 있을 수 있다.

- singleTop

  활동의 인스턴스가 이미 현재 작업의 맨 위에 있으면 시스템은 활동의 새 인스턴스를 생성하지 않고 `onNewIntent()` 메서드를 호출하여 인텐트를 기존 인스턴스로 라우팅한다. 활동은 여러 번 인스턴스화될 수 있고 각 인스턴스는 서로 다른 작업에 속할 수 있으며 한 작업에는 여러 인스턴스가 있을 수 있다(단, 백 스택의 맨 위에 있는 활동이 활동의 기존 인스턴스가 아닐 때에만).

- singleTask

  시스템이 새 작업을 생성하고 새 작업의 루트에 있는 활동을 인스턴스화한다. 그러나 활동의 인스턴스가 이미 별도의 작업에 있다면 시스템은 새 인스턴스를 생성하지 않고 `onNewIntent()` 메서드를 호출하여 인텐트를 기존 인스턴스로 라우팅한다. 활동의 인스턴스가 한 번에 하나만 존재할 수 있다.

- singleInstance : 이해하기 어렵다. 자세한 설명은 안드로이드 공식 개발자 페이지를 참고하자.

<br>

**2. 인텐트 플래그 사용**

액티비티를 시작할 때 `startActivity()`에 전달하는 인텐트에 플래그를 포함함으로써 액티비티와 작업의 기본 연결을 수정할 수 있습니다. 기본 동작을 수정하는 데 사용할 수 있는 플래그는 다음과 같다.

- FLAG_ACTIVITY_NEW_TASK

  활동을 새 작업에서 시작한다. 지금 시작하고 있는 활동에 대해 이미 실행 중인 작업이 있으면 그 작업이 마지막 상태가 복원되어 포그라운드로 이동하고 활동은 `onNewIntent()`의 새 인텐트를 수신한다.

  이 플래그를 사용하면 이전 섹션에서 설명한 `"singleTask"` launchMode 값과 동일한 동작이 발생한다.

- FLAG_ACTIVITY_SINGLE_TOP

  시작 중인 활동이 현재 활동(백 스택의 맨 위에 있는)이면 활동의 새 인스턴스가 생성되는 대신 기존 인스턴스가 `onNewIntent()` 호출을 수신한다.

  이 플래그를 사용하면 이전 섹션에서 설명한 `"singleTop"` launchMode 값과 동일한 동작이 발생한다.

- FLAG_ACTIVITY_CLEAR_TOP

  시작 중인 활동이 현재 작업에서 이미 실행 중이면 활동의 새 인스턴스가 실행되는 대신 작업의 맨 위에 있는 다른 모든 활동이 제거되고 이 인텐트가 `onNewIntent()`를 통해 활동(이제 맨 위에 있음)의 다시 시작된 인스턴스로 전달된다.

  이 동작을 발생시키는 launchMode 속성 값은 없다.`FLAG_ACTIVITY_CLEAR_TOP`은 `FLAG_ACTIVITY_NEW_TASK`와 함께 가장 자주 사용된다.

  이러한 플래그를 함께 사용하면 또 다른 작업에 있는 기존 활동을 찾아 인텐트에 응답할 수 있는 위치에 활동을 넣을 수 있다.

<br>

**3. 백 스택 삭제**

사용자가 오랜 시간 동안 작업을 떠나있으면 시스템은 루트 액티비티를 제외한 모든 액티비티를 작업에서 삭제한다. 사용자가 작업으로 다시 돌아오면 루트 액티비티만 복원된다. 시스템이 이런 방식으로 동작하는 이유는 오랜 시간이 지나면 사용자가 이전에 하고 있던 일을 그만두고 작업으로 돌아왔을 때 새로운 일을 시작할 가능성이 크기 때문이다.

- alwaysRetainTaskState

  작업의 루트 액티비티에서 이 속성을 "true"로 설정하면 방금 설명한 기본 동작이 일어나지 않는다. 작업은 오랜 시간이 지난 후에도 스택의 모든 액티비티를 유지한다.

- clearTaskOnLaunch

  작업의 루트 활동에서 이 속성을 "true"로 설정하면 사용자가 작업을 떠났다가 작업으로 다시 돌아올 때마다 스택이 루트 액티비티까지 삭제된다. 다시 말해서 `alwaysRetainTaskState`와 정반대이다. 사용자는 항상 작업의 초기 상태로 돌아오게 되며 이는 아주 잠깐만 작업을 떠났다가 돌아와도 마찬가지이다.

- finishOnTaskLaunch

  이 속성은 `clearTaskOnLaunch`와 비슷하지만 작업 전체가 아니라 단일 액티비티에서 작동합니다. 또한 이 속성을 사용하면 루트 액티비티를 포함하여 어떤 액티비티라도 지울 수 있다. 이 속성을 "true"로 설정하면 액티비티는 현재 세션에 대해서만 작업의 일부로 유지된다. 사용자가 작업을 떠났다가 다시 돌아오면 이 작업은 더 이상 존재하지 않는다.

---

참고문서 - [안드로이드 공식 개발자 페이지](https://developer.android.com/?hl=ko)
